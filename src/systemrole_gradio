import gradio as gr
from openai import OpenAI
import os
from datetime import datetime

class LLMAnalyzer:
    """LLM åˆ†æå¼•æ“ï¼ˆå¸¦å¼ºåŒ–System Roleï¼‰"""
    
    SYSTEM_PROMPT = """
    # Role: GitHubå®‰å…¨åˆ†æä¸“å®¶
    
    ## è¾“å‡ºè§„èŒƒ
    1. æ ¼å¼è¦æ±‚ï¼š
       - å¿…é¡»ä½¿ç”¨Markdown
       - é£é™©é¡¹ç”¨ğŸ”´/ğŸŸ¡/ğŸŸ¢æ ‡è¯†ä¸¥é‡ç¨‹åº¦
       - ä»£ç å—æ ‡æ³¨è¯­è¨€ç±»å‹
    2. å†…å®¹è¦æ±‚ï¼š
       - æ¯ä¸ªæ¼æ´å¿…é¡»åŒ…å«ï¼š
         * CVEç¼–å·ï¼ˆå¦‚æ— åˆ™æ ‡"N/A"ï¼‰
         * ç½®ä¿¡åº¦ï¼ˆ1-5çº§ï¼‰
         * ä¿®å¤å»ºè®®
    
    ## è¡Œä¸ºçº¦æŸ
    1. ç¦æ­¢ï¼š
       - è™šæ„æœªéªŒè¯çš„æ¼æ´
       - æä¾›å…·ä½“æ”»å‡»Payload
    2. ä¸ç¡®å®šæ—¶å›å¤ï¼š
       "âš ï¸ éœ€è¦æ›´å¤šä¸Šä¸‹æ–‡ç¡®è®¤"
    """

    def __init__(self):
        self.client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

    def analyze(self, code: str) -> str:
        """æ‰§è¡Œå®‰å…¨åˆ†æ"""
        response = self.client.chat.completions.create(
            model="gpt-4-turbo",
            messages=[
                {"role": "system", "content": self.SYSTEM_PROMPT},
                {"role": "user", "content": f"åˆ†æä»¥ä¸‹ä»£ç çš„å®‰å…¨é£é™©ï¼š\n```python\n{code}\n```"}
            ],
            temperature=0.3  # é™ä½éšæœºæ€§
        )
        return response.choices[0].message.content

def gradio_interface():
    """Gradio äº¤äº’ç•Œé¢ï¼ˆv0.4.1å¸ƒå±€ä¼˜åŒ–ï¼‰"""
    analyzer = LLMAnalyzer()
    
    with gr.Blocks(
        title="GitHubSentinel v0.4.1",
        css=".danger { color: red } .warning { color: orange }"
    ) as app:
        
        # æ ‡é¢˜åŒº
        gr.Markdown("""# ğŸ›¡ï¸ GitHubSentinel  
        **AIé©±åŠ¨çš„ä»£ç å®‰å…¨åˆ†æå·¥å…·**""")
        
        # è¾“å…¥è¾“å‡ºåŒº
        with gr.Row():
            with gr.Column(scale=1):
                code_input = gr.Code(
                    label="è¾“å…¥ä»£ç ",
                    language="python",
                    lines=10,
                    interactive=True
                )
                submit_btn = gr.Button("åˆ†æ", variant="primary")
                
                with gr.Accordion("é«˜çº§é€‰é¡¹", open=False):
                    language = gr.Dropdown(
                        ["Python", "JavaScript", "Go"],
                        label="ä»£ç è¯­è¨€",
                        value="Python"
                    )
                    scan_level = gr.Slider(1, 3, label="æ‰«ææ·±åº¦")
            
            with gr.Column(scale=2):
                report = gr.Markdown(label="å®‰å…¨æŠ¥å‘Š")
                risk_score = gr.Label(
                    label="é£é™©è¯„åˆ†",
                    value={"å®‰å…¨": 0, "è­¦å‘Š": 0, "å±é™©": 0}
                )
        
        # äº¤äº’é€»è¾‘
        submit_btn.click(
            fn=analyzer.analyze,
            inputs=code_input,
            outputs=report,
            api_name="analyze"
        )
        
        # ç¤ºä¾‹åŒº
        gr.Examples(
            examples=[
                ["os.system('rm -rf /')", "é«˜å±å‘½ä»¤ç¤ºä¾‹"],
                ["eval(user_input)", "åŠ¨æ€æ‰§è¡Œé£é™©"],
            ],
            inputs=code_input,
            label="ç‚¹å‡»åŠ è½½ç¤ºä¾‹"
        )
    
    return app

if __name__ == "__main__":
    # å¯åŠ¨åº”ç”¨
    app = gradio_interface()
    app.launch(
        server_name="0.0.0.0",
        server_port=7860,
        share=False
    )
